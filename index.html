<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Controle de Dieta ‚Äî Herbert</title>
  <style>
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial,"Apple Color Emoji","Segoe UI Emoji";background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:20px}
    .container{max-width:1200px;margin:0 auto;background:rgba(255,255,255,.95);border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,.1);backdrop-filter:blur(10px);overflow:hidden}
    .header{background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);padding:24px;color:#fff}
    .header-top{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .header h1{margin:8px 0 2px;font-size:2rem;text-shadow:0 2px 4px rgba(0,0,0,.25)}
    .date-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .date-display{font-weight:700}
    .date-controls button,.date-controls input[type="date"],.kcaltoggle button{
      border:none;border-radius:10px;padding:8px 12px;font-weight:600;cursor:pointer
    }
    .date-controls{display:flex;gap:6px;align-items:center}
    .date-controls button{background:#ffffff22;color:#fff}
    .date-controls button:hover{background:#ffffff33}
    .kcaltoggle{display:flex;gap:6px;align-items:center;margin-top:8px}
    .kcaltoggle button{background:#ffffff22;color:#fff}
    .kcaltoggle button.active{background:#22c55e}
    .nav-tabs{display:flex;background:#f8f9fa;border-bottom:2px solid #e9ecef}
    .nav-tab{flex:1;padding:14px 18px;background:none;border:none;font-size:1rem;font-weight:600;cursor:pointer;transition:background .2s ease;color:#6c757d}
    .nav-tab[aria-selected="true"]{background:#fff;color:#4facfe;border-bottom:3px solid #4facfe}
    .nav-tab:hover{background:rgba(79,172,254,.1)}
    .tab-panel{display:none;padding:24px}
    .tab-panel[aria-hidden="false"]{display:block}
    .meal-card{background:#fff;border-radius:15px;padding:22px;margin-bottom:16px;box-shadow:0 5px 15px rgba(0,0,0,.08);border-left:5px solid #4facfe;transition:transform .2s, box-shadow .2s}
    .meal-card:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,.15)}
    .meal-card.completed{border-left-color:#28a745;background:linear-gradient(135deg,#f8fff9 0%,#e8f5e8 100%)}
    .meal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .meal-time{font-size:1.2rem;font-weight:700;color:#2c3e50}
    .meal-name{font-size:1rem;color:#7f8c8d}
    .complete-btn{padding:8px 16px;background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);color:#fff;border:none;border-radius:25px;cursor:pointer;font-weight:700}
    .complete-btn.completed{background:linear-gradient(135deg,#28a745 0%,#20c997 100%)}
    .food-options{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;margin-bottom:8px}
    .food-group{background:#f8f9fa;padding:12px;border-radius:10px}
    .food-group h4{color:#495057;margin:0 0 8px;font-size:.95rem;text-transform:uppercase;letter-spacing:.8px}
    .food-options-list{display:flex;flex-wrap:wrap;gap:8px}
    .food-option{padding:6px 10px;background:#fff;border:2px solid #e9ecef;border-radius:20px;font-size:.9rem;cursor:pointer}
    .food-option[aria-pressed="true"]{background:#4facfe;color:#fff;border-color:#4facfe}
    .fruit-item{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;background:#fff;border:2px solid #e9ecef;border-radius:999px}
    .fruit-qty{min-width:2ch;text-align:center;font-weight:700}
    .fruit-btn{border:none;background:#eef6ff;padding:2px 8px;border-radius:999px;cursor:pointer}
    .fruit-kcal{font-size:.8rem;color:#6c757d}
    .meal-calories{font-size:.95rem;color:#2c3e50;margin-top:6px;font-weight:700}
    .supplements{background:linear-gradient(135deg,#ffeaa7 0%,#fab1a0 100%);padding:12px;border-radius:10px;margin-top:8px}
    .supplements h4{margin:0 0 6px}
    .progress-section,.notes-section{background:#fff;border-radius:15px;padding:20px;margin-bottom:16px;box-shadow:0 5px 15px rgba(0,0,0,.08)}
    .progress-bar{width:100%;height:18px;background:#e9ecef;border-radius:9px;overflow:hidden;margin:10px 0}
    .progress-fill{height:100%;background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);transition:width .4s;border-radius:9px}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-top:12px}
    .stat-card{background:linear-gradient(135deg,#a8edea 0%,#fed6e3 100%);padding:16px;border-radius:12px;text-align:center}
    .stat-number{font-size:1.4rem;font-weight:800;color:#2c3e50}
    .stat-label{color:#7f8c8d;font-size:.9rem;margin-top:4px}
    .goals{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;margin-top:10px}
    .goal-item{display:flex;align-items:center;gap:8px}
    .goal-item input{width:100%;padding:8px 10px;border:2px solid #e9ecef;border-radius:10px;font:inherit}
    .notes-input{width:100%;min-height:120px;padding:12px;border:2px solid #e9ecef;border-radius:10px;font:inherit}
    @media (max-width:768px){.header h1{font-size:1.6rem}.tab-panel{padding:18px}.meal-card{padding:18px}.food-options{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="header-top">
        <div>
          <h1>üçΩÔ∏è Controle de Dieta</h1>
          <div class="date-row">
            <span class="date-display" id="friendlyDate">‚Äî</span>
            <div class="date-controls">
              <button id="prevDayBtn" type="button">‚üµ Dia anterior</button>
              <input id="datePicker" type="date" />
              <button id="todayBtn" type="button">Hoje</button>
              <button id="nextDayBtn" type="button">Dia seguinte ‚ü∂</button>
            </div>
          </div>
          <div class="kcaltoggle">
            <strong>Meta r√°pida:</strong>
            <button id="btnCalRest" type="button">Descanso 2300</button>
            <button id="btnCalTrain" type="button" class="active">Treino 2600</button>
          </div>
        </div>
      </div>
    </header>

    <div class="nav-tabs" role="tablist" aria-label="Se√ß√µes">
      <button id="tab-today" class="nav-tab" role="tab" aria-selected="true" aria-controls="panel-today">Hoje</button>
      <button id="tab-progress" class="nav-tab" role="tab" aria-selected="false" aria-controls="panel-progress">Progresso</button>
      <button id="tab-notes" class="nav-tab" role="tab" aria-selected="false" aria-controls="panel-notes">Anota√ß√µes</button>
    </div>

    <main>
      <section id="panel-today" class="tab-panel" role="tabpanel" aria-labelledby="tab-today" aria-hidden="false">
        <div id="mealsContainer"></div>
      </section>

      <section id="panel-progress" class="tab-panel" role="tabpanel" aria-labelledby="tab-progress" aria-hidden="true">
        <div class="progress-section">
          <h3>Progresso do Dia</h3>
          <div class="progress-bar"><div id="progressFill" class="progress-fill" style="width:0%"></div></div>
          <p id="progressText">0% das refei√ß√µes conclu√≠das</p>
          <div class="goals">
            <div class="goal-item">
              <label for="goalFruit">Meta de frutas (por√ß√µes):</label>
              <input id="goalFruit" type="number" min="0" step="1"/>
            </div>
            <div class="goal-item">
              <label for="goalCalories">Meta de calorias (kcal):</label>
              <input id="goalCalories" type="number" min="0" step="50"/>
            </div>
            <button id="saveGoalsBtn" class="complete-btn save-goals" type="button">Salvar metas</button>
          </div>
        </div>
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-number" id="completedMeals">0</div><div class="stat-label">Refei√ß√µes conclu√≠das</div></div>
          <div class="stat-card"><div class="stat-number" id="totalMeals">6</div><div class="stat-label">Total de refei√ß√µes</div></div>
          <div class="stat-card"><div class="stat-number" id="currentStreak">0</div><div class="stat-label">Sequ√™ncia 100% (dias)</div></div>
          <div class="stat-card"><div class="stat-number" id="weeklyAverage">0%</div><div class="stat-label">M√©dia semanal</div></div>
          <div class="stat-card"><div class="stat-number" id="fruitProgress">0 / 0</div><div class="stat-label">Frutas (por√ß√µes/meta)</div></div>
          <div class="stat-card"><div class="stat-number" id="calProgress">0 / 0</div><div class="stat-label">Calorias (kcal consumidas/meta)</div></div>
        </div>
      </section>

      <section id="panel-notes" class="tab-panel" role="tabpanel" aria-labelledby="tab-notes" aria-hidden="true">
        <div class="notes-section">
          <h3>Anota√ß√µes</h3>
          <textarea id="notesInput" class="notes-input" placeholder="Observa√ß√µes sobre o dia, fome, treino, sono..."></textarea>
          <button id="saveNotesBtn" class="complete-btn" type="button">üíæ Salvar Anota√ß√µes</button>
        </div>
      </section>
    </main>
  </div>

  <script>
    // ============== Plano di√°rio (fiel √† dieta) ==============
    const dietPlan = [
      { time:"06:30", name:"Caf√© da manh√£", foods:{
          Prote√≠na:["3 ovos","120g frango","120g carne","120g peixe"],
          Carboidrato:["80g mandioca","100g batata-doce","100g arroz","80g cuscuz","80g macarr√£o integral"],
          Fruta:["banana (1 un)","ma√ß√£ (1 un)","laranja (1 un)","mixirica (1 un)","mam√£o (100g)","manga (100g)","uva (100g)","mel√£o (100g)","melancia (100g)"],
          Folhas:["alface","br√≥colis"]
        },
        supplements:"30 min antes: Sel√™nio 200mcg | Ap√≥s: Vitamina D3 10.000ui + K2 200mcg, B12 1mg, √îmega 3 (6-8 c√°ps), Creatina 5g, NAC 600mg"
      },
      { time:"10:00", name:"Lanche / Pr√©-treino", foods:{
          Prote√≠na:["120g frango","120g carne","120g peixe","3 ovos"],
          Carboidrato:["80g batata-doce","100g arroz","80g mandioca","80g cuscuz","80g macarr√£o integral"],
          Fruta:["banana (1 un)","ma√ß√£ (1 un)","laranja (1 un)","mixirica (1 un)","mam√£o (100g)","manga (100g)","uva (100g)","mel√£o (100g)","melancia (100g)"]
        },
        supplements:"Pr√©-treino (se treino 12h): Glicerina 15ml em 1L √°gua"
      },
      { time:"13:00", name:"Almo√ßo (p√≥s-treino)", foods:{
          Prote√≠na:["150g frango","150g carne","150g peixe","3 ovos"],
          Carboidrato:["120g arroz","120g batata-doce","120g mandioca","100g cuscuz","100g macarr√£o integral"],
          Vegetais:["salada + br√≥colis"],
          Fruta:["banana (1 un)","ma√ß√£ (1 un)","laranja (1 un)","mixirica (1 un)","mam√£o (100g)","manga (100g)","uva (100g)","mel√£o (100g)","melancia (100g)"]
        },
        supplements:"Ap√≥s refei√ß√£o: Col√°geno tipo II 40mg, Glucosamina 1,5g + Condroitina 1,2g"
      },
      { time:"16:00", name:"Lanche da tarde", foods:{
          Prote√≠na:["120g frango","120g carne","120g peixe","3 ovos"],
          Carboidrato:["80g batata-doce","100g arroz","80g mandioca","80g cuscuz","80g macarr√£o integral"],
          Folhas:["alface","br√≥colis"],
          Fruta:["banana (1 un)","ma√ß√£ (1 un)","laranja (1 un)","mixirica (1 un)","mam√£o (100g)","manga (100g)","uva (100g)","mel√£o (100g)","melancia (100g)"]
        },
        supplements:"Sem manipulados fixos"
      },
      { time:"19:00", name:"Jantar", foods:{
          Prote√≠na:["150g frango","150g carne","150g peixe","3 ovos"],
          Vegetais:["salada verde + br√≥colis"],
          "Carboidrato (opcional)":["80g arroz","80g batata-doce","80g mandioca","80g cuscuz","80g macarr√£o integral"],
          Fruta:["banana (1 un)","ma√ß√£ (1 un)","laranja (1 un)","mixirica (1 un)","mam√£o (100g)","manga (100g)","uva (100g)","mel√£o (100g)","melancia (100g)"]
        },
        supplements:"Sem manipulados fixos"
      },
      { time:"21:00", name:"Antes de dormir", foods:{},
        supplements:"1h antes: Magn√©sio 500mg + Zinco 30mg + Vitamina C 1g | Antes dormir: Melatonina SL 2mg, Glicina 3g"
      }
    ];

    // ============== Calorias (corrigidas) ==============
    const kcalDB = {
      // Prote√≠nas (cozidas, magras)
      "3 ovos":210,
      "120g frango":198,  "150g frango":248,
      "120g carne":230,   "150g carne":290,
      "120g peixe":170,   "150g peixe":213,

      // Carboidratos (cozidos)
      "80g mandioca":128, "120g mandioca":192,
      "100g batata-doce":86, "120g batata-doce":103,
      "100g arroz":130,   "120g arroz":156,
      "80g cuscuz":96,    "100g cuscuz":120,
      "80g macarr√£o integral":110, "100g macarr√£o integral":138,

      // Folhas/vegetais
      "alface":5, "br√≥colis":34, "salada + br√≥colis":60, "salada verde + br√≥colis":60,

      // Frutas
      "banana (1 un)":105, "ma√ß√£ (1 un)":95, "laranja (1 un)":62, "mixirica (1 un)":47,
      "mam√£o (100g)":43, "manga (100g)":60, "uva (100g)":69, "mel√£o (100g)":34, "melancia (100g)":30
    };

    // ============== Datas, metas e storage ==============
    const STORAGE_PREFIX = 'dietData-';
    const GOALS_KEY = 'dietGoals';

    let selectedDate = new Date(); // data atualmente exibida
    let mealStatus = {};           // { [index]: boolean }
    let selectedFoods = {};        // { [index]: { Categoria: "op√ß√£o", Fruta: { "banana (1 un)": 1, ... } } }
    let dailyNotes = '';
    let goals = loadGoals();

    const $ = (s, r=document)=>r.querySelector(s);
    const $$ = (s, r=document)=>[...r.querySelectorAll(s)];
    const toISO = (d)=>new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())).toISOString().slice(0,10); // YYYY-MM-DD (sem fuso)
    const fromISO = (iso)=>{ const [y,m,dd]=iso.split('-').map(Number); const dt=new Date(); dt.setFullYear(y, m-1, dd); dt.setHours(0,0,0,0); return dt; };
    const today = ()=>{ const d=new Date(); d.setHours(0,0,0,0); return d; };
    const dayKey = (d)=> STORAGE_PREFIX + toISO(d);

    function formatFriendly(d){
      return d.toLocaleDateString('pt-BR', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
    }

    function loadGoals(){
      const g = JSON.parse(localStorage.getItem(GOALS_KEY) || '{}');
      return { fruitServings: g.fruitServings ?? 3, dailyCalories: g.dailyCalories ?? 2600 };
    }
    function saveGoals(go){ localStorage.setItem(GOALS_KEY, JSON.stringify(go)); }

    function saveDayPercent(d, percent){
      const histKey = 'dietHistory';
      const hist = JSON.parse(localStorage.getItem(histKey) || '{}');
      hist[toISO(d)] = percent;
      localStorage.setItem(histKey, JSON.stringify(hist));
    }
    function getLastNDays(n=7){
      const hist = JSON.parse(localStorage.getItem('dietHistory')||'{}');
      const arr=[];
      for(let i=n-1;i>=0;i--){
        const d=new Date(); d.setDate(d.getDate()-i);
        const k=toISO(d);
        if(hist[k]!=null) arr.push(hist[k]);
      }
      return arr;
    }
    function calcWeeklyAverage(){
      const a=getLastNDays(7); if(!a.length) return 0;
      const s=a.reduce((x,y)=>x+y,0); return Math.round(s/a.length);
    }
    function calcStreak(th=100){
      const hist = JSON.parse(localStorage.getItem('dietHistory')||'{}');
      let s=0;
      for(let i=0;;i++){
        const d=new Date(); d.setDate(d.getDate()-i);
        const k=toISO(d), v=hist[k];
        if(v==null || v<th) break;
        s++;
      }
      return s;
    }

    function saveAll(){
      localStorage.setItem(dayKey(selectedDate), JSON.stringify({ mealStatus, selectedFoods, dailyNotes, date: toISO(selectedDate) }));
    }
    function loadAll(){
      const raw = localStorage.getItem(dayKey(selectedDate));
      if(raw){
        const data = JSON.parse(raw);
        mealStatus = data.mealStatus || {};
        selectedFoods = data.selectedFoods || {};
        for(const [idx,obj] of Object.entries(selectedFoods)){
          if(obj?.Fruta && typeof obj.Fruta === 'string'){
            obj.Fruta = { [obj.Fruta]: 1 };
          }
        }
        dailyNotes = data.dailyNotes || '';
      } else {
        mealStatus = {}; selectedFoods = {}; dailyNotes = '';
      }
    }

    function getKcal(label){ return kcalDB[label] ?? 0; }
    function mealCalories(index){
      const sel = selectedFoods[index] || {};
      let t=0;
      for(const [cat,val] of Object.entries(sel)){
        if(cat==='Fruta' && val && typeof val==='object'){
          for(const [opt, qty] of Object.entries(val)){ if(!qty) continue; t += getKcal(opt) * qty; }
        } else if (typeof val === 'string'){ t += getKcal(val); }
      }
      return t;
    }
    function dayCalories(){
      let s=0; for(let i=0;i<dietPlan.length;i++) s+=mealCalories(i); return s;
    }
    function fruitServingsConsumed(){
      let s=0;
      for(const idx in selectedFoods){
        const f = selectedFoods[idx]?.Fruta; if(!f) continue;
        for(const qty of Object.values(f)) s += (qty||0);
      }
      return s;
    }

    // ---------- Renderiza√ß√£o ----------
    function renderHeaderDate(){
      $('#friendlyDate').textContent = formatFriendly(selectedDate);
      $('#datePicker').value = toISO(selectedDate);
      // Toggle dos bot√µes de meta
      $('#btnCalTrain').classList.toggle('active', goals.dailyCalories==2600);
      $('#btnCalRest').classList.toggle('active', goals.dailyCalories==2300);
    }

    function renderMeals(){
      const wrap = $('#mealsContainer'); wrap.textContent='';
      dietPlan.forEach((meal,index)=>{
        const card=document.createElement('article');
        card.className='meal-card'+(mealStatus[index]?' completed':'');
        const h=document.createElement('div'); h.className='meal-header';
        const l=document.createElement('div');
        const t=document.createElement('div'); t.className='meal-time'; t.textContent=meal.time;
        const n=document.createElement('div'); n.className='meal-name'; n.textContent=meal.name;
        l.append(t,n);
        const btn=document.createElement('button'); btn.className='complete-btn'+(mealStatus[index]?' completed':'');
        btn.type='button'; btn.dataset.action='toggle-meal'; btn.dataset.index=String(index);
        btn.textContent=mealStatus[index]?'‚úì Conclu√≠da':'Marcar como Conclu√≠da';
        h.append(l,btn); card.appendChild(h);

        const categories=Object.entries(meal.foods||{});
        if(categories.length){
          const optWrap=document.createElement('div'); optWrap.className='food-options';
          categories.forEach(([cat,options])=>{
            if(!options||!options.length) return;
            const g=document.createElement('div'); g.className='food-group';
            const title=document.createElement('h4'); title.textContent=cat;
            const list=document.createElement('div'); list.className='food-options-list';

            if(cat==='Fruta'){
              const store = selectedFoods[index]?.Fruta||{};
              options.forEach(option=>{
                const item=document.createElement('div'); item.className='fruit-item';
                const dec=document.createElement('button'); dec.className='fruit-btn'; dec.type='button'; dec.textContent='‚àí';
                dec.dataset.action='fruit-dec'; dec.dataset.mealIndex=String(index); dec.dataset.option=option;
                const qty=document.createElement('span'); qty.className='fruit-qty'; qty.textContent=String(store[option]||0);
                qty.dataset.mealIndex=String(index); qty.dataset.option=option;
                const inc=document.createElement('button'); inc.className='fruit-btn'; inc.type='button'; inc.textContent='+';
                inc.dataset.action='fruit-inc'; inc.dataset.mealIndex=String(index); inc.dataset.option=option;
                const lbl=document.createElement('span'); lbl.textContent=option;
                const kc=document.createElement('span'); kc.className='fruit-kcal'; kc.textContent=`(${getKcal(option)} kcal/por√ß√£o)`;
                item.append(dec,qty,inc,lbl,kc); list.appendChild(item);
              });
            } else {
              options.forEach(option=>{
                const b=document.createElement('button'); b.className='food-option'; b.type='button';
                b.setAttribute('aria-pressed', String(selectedFoods[index]?.[cat]===option));
                b.dataset.action='select-food'; b.dataset.mealIndex=String(index); b.dataset.category=cat; b.dataset.option=option;
                b.textContent=`${option} ¬∑ ${getKcal(option)} kcal`;
                list.appendChild(b);
              });
            }
            g.append(title,list); optWrap.appendChild(g);
          });
          card.appendChild(optWrap);
        }

        const kcal=document.createElement('div'); kcal.className='meal-calories'; kcal.id=`meal-kcal-${index}`;
        kcal.textContent=`Calorias estimadas desta refei√ß√£o: ${mealCalories(index)} kcal`;
        card.appendChild(kcal);

        if(meal.supplements){
          const sup=document.createElement('div'); sup.className='supplements';
          const h4=document.createElement('h4'); h4.textContent='üíä Suplementa√ß√£o';
          const p=document.createElement('div'); p.className='supplement-list'; p.textContent=meal.supplements;
          sup.append(h4,p); card.appendChild(sup);
        }

        wrap.appendChild(card);
      });
    }

    function updateProgress(saveHist=true){
      const completed=Object.values(mealStatus).filter(Boolean).length;
      const total=dietPlan.length;
      const percent=Math.round((completed/total)*100);

      $('#progressFill').style.width=percent+'%';
      $('#progressText').textContent=`${percent}% das refei√ß√µes conclu√≠das`;
      $('#completedMeals').textContent=String(completed);
      $('#totalMeals').textContent=String(total);

      if(saveHist) saveDayPercent(selectedDate, percent);
      $('#currentStreak').textContent=String(calcStreak(100));
      $('#weeklyAverage').textContent=`${calcWeeklyAverage()}%`;

      const f=fruitServingsConsumed(), dcal=dayCalories();
      $('#fruitProgress').textContent=`${f} / ${goals.fruitServings}`;
      $('#calProgress').textContent=`${dcal} / ${goals.dailyCalories}`;
    }

    function refreshMealKcal(index){
      const el=document.getElementById(`meal-kcal-${index}`);
      if(el) el.textContent=`Calorias estimadas desta refei√ß√£o: ${mealCalories(index)} kcal`;
    }

    // ---------- Tabs ----------
    function setActiveTab(tabId){
      const panels=['panel-today','panel-progress','panel-notes'];
      const tabs=['tab-today','tab-progress','tab-notes'];
      tabs.forEach((id,i)=>{
        const active=id===tabId;
        document.getElementById(id).setAttribute('aria-selected', String(active));
        document.getElementById(panels[i]).setAttribute('aria-hidden', String(!active));
      });
      if(tabId==='tab-progress'){
        $('#goalFruit').value=String(goals.fruitServings);
        $('#goalCalories').value=String(goals.dailyCalories);
        updateProgress(false);
      }
      if(tabId==='tab-notes'){ $('#notesInput').value=dailyNotes; }
    }

    function setupTabs(){
      const tabList=document.querySelector('.nav-tabs');
      tabList.addEventListener('click',(e)=>{
        const btn=e.target.closest('.nav-tab'); if(!btn) return;
        setActiveTab(btn.id);
      });
    }

    // ---------- Intera√ß√µes ----------
    function setupInteractions(){
      const container=$('#mealsContainer');
      container.addEventListener('click',(e)=>{
        const t=e.target; if(!(t instanceof HTMLElement)) return;

        const toggleBtn=t.closest('button[data-action="toggle-meal"]');
        if(toggleBtn){
          const idx=Number(toggleBtn.dataset.index);
          mealStatus[idx]=!mealStatus[idx];
          saveAll(); renderMeals(); updateProgress();
          return;
        }

        const foodBtn=t.closest('button[data-action="select-food"]');
        if(foodBtn){
          const mealIndex=Number(foodBtn.dataset.mealIndex);
          const category=foodBtn.dataset.category;
          const option=foodBtn.dataset.option;
          selectedFoods[mealIndex] ||= {};
          const cur=selectedFoods[mealIndex][category];
          selectedFoods[mealIndex][category]= cur===option ? undefined : option;
          saveAll();
          const group=foodBtn.parentElement;
          if(group){ [...group.querySelectorAll('button[data-action="select-food"]')].forEach(b=>b.setAttribute('aria-pressed','false')); }
          foodBtn.setAttribute('aria-pressed', String(selectedFoods[mealIndex][category]===option));
          refreshMealKcal(mealIndex); updateProgress(false);
          return;
        }

        const inc=t.closest('button[data-action="fruit-inc"]');
        const dec=t.closest('button[data-action="fruit-dec"]');
        if(inc||dec){
          const mealIndex=Number((inc||dec).dataset.mealIndex);
          const option=(inc||dec).dataset.option;
          selectedFoods[mealIndex] ||= {};
          selectedFoods[mealIndex].Fruta ||= {};
          const cur=selectedFoods[mealIndex].Fruta[option]||0;
          const next=Math.max(0, cur + (inc?1:-1));
          selectedFoods[mealIndex].Fruta[option]=next;
          saveAll();
          const qtyEl=container.querySelector(`.fruit-qty[data-meal-index="${mealIndex}"][data-option="${option}"]`);
          if(qtyEl) qtyEl.textContent=String(next);
          refreshMealKcal(mealIndex); updateProgress(false);
          return;
        }
      });

      // notas
      $('#saveNotesBtn').addEventListener('click',(e)=>{
        dailyNotes=$('#notesInput').value;
        saveAll();
        const b=e.currentTarget; b.textContent='‚úì Salvo!'; b.classList.add('completed');
        setTimeout(()=>{ b.textContent='üíæ Salvar Anota√ß√µes'; b.classList.remove('completed'); },1400);
      });

      // metas
      $('#saveGoalsBtn').addEventListener('click',()=>{
        const f=Number($('#goalFruit').value || goals.fruitServings);
        const c=Number($('#goalCalories').value || goals.dailyCalories);
        goals={ fruitServings:Math.max(0,Math.floor(f)), dailyCalories:Math.max(0,Math.floor(c)) };
        saveGoals(goals); updateProgress(false);
        const b=$('#saveGoalsBtn'); b.textContent='‚úì Metas salvas'; b.classList.add('completed');
        setTimeout(()=>{ b.textContent='Salvar metas'; b.classList.remove('completed'); },1200);
      });

      // toggles r√°pidos de kcal
      $('#btnCalRest').addEventListener('click',()=>{
        goals.dailyCalories=2300; saveGoals(goals); renderHeaderDate(); updateProgress(false);
      });
      $('#btnCalTrain').addEventListener('click',()=>{
        goals.dailyCalories=2600; saveGoals(goals); renderHeaderDate(); updateProgress(false);
      });

      // controles de data
      $('#datePicker').addEventListener('change',(e)=>{
        const val=e.target.value; if(!val) return;
        selectedDate=fromISO(val);
        loadAll(); renderHeaderDate(); renderMeals(); updateProgress(false);
      });
      $('#todayBtn').addEventListener('click',()=>{
        selectedDate=today(); loadAll(); renderHeaderDate(); renderMeals(); updateProgress(false);
      });
      $('#prevDayBtn').addEventListener('click',()=>{
        selectedDate.setDate(selectedDate.getDate()-1);
        loadAll(); renderHeaderDate(); renderMeals(); updateProgress(false);
      });
      $('#nextDayBtn').addEventListener('click',()=>{
        selectedDate.setDate(selectedDate.getDate()+1);
        loadAll(); renderHeaderDate(); renderMeals(); updateProgress(false);
      });
    }

    // ---------- Boot ----------
    document.addEventListener('DOMContentLoaded',()=>{
      selectedDate=today();
      renderHeaderDate();
      loadAll();
      renderMeals();
      updateProgress(false);
      setupTabs();
      setupInteractions();
    });
  </script>
</body>
</html>
