<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Controle de Dieta ‚Äî Herbert</title>
  <style>
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial,"Apple Color Emoji","Segoe UI Emoji";background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:20px}
    .container{max-width:1200px;margin:0 auto;background:rgba(255,255,255,.95);border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,.1);backdrop-filter:blur(10px);overflow:hidden}
    .header{background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);padding:24px;color:#fff}
    .header h1{margin:8px 0 2px;font-size:2rem;text-shadow:0 2px 4px rgba(0,0,0,.25); text-align:center}
    .header-summary{display:flex;justify-content:center;gap:16px;margin-top:12px;margin-bottom:12px;flex-wrap:wrap}
    .summary-item{background:#ffffff22;padding:8px 16px;border-radius:999px;font-weight:600;font-size:.95rem;backdrop-filter:blur(5px)}
    .date-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:center}
    .date-display{font-weight:700}
    .controls-line{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px;align-items:center;justify-content:center}
    .btn,.input{border:none;border-radius:10px;padding:8px 12px;font-weight:600}
    .btn{cursor:pointer;background-color:#eee}
    .btn.ghost{background:#ffffff22;color:#fff}
    .btn.ghost:hover{background:#ffffff33}
    .btn.active{background:#22c55e;color:#fff}
    .input{background:#ffffffee}
    .nav-tabs{display:flex;background:#f8f9fa;border-bottom:2px solid #e9ecef}
    .nav-tab{flex:1;padding:14px 18px;background:none;border:none;font-size:1rem;font-weight:600;cursor:pointer;transition:background .2s ease;color:#6c757d}
    .nav-tab[aria-selected="true"]{background:#fff;color:#4facfe;border-bottom:3px solid #4facfe}
    .nav-tab:hover{background:rgba(79,172,254,.1)}
    .tab-panel{display:none;padding:24px;animation:fadeIn .5s ease}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .tab-panel[aria-hidden="false"]{display:block}
    .meal-card{background:#fff;border-radius:15px;padding:22px;margin-bottom:16px;box-shadow:0 5px 15px rgba(0,0,0,.08);border-left:5px solid #4facfe;transition:transform .2s,box-shadow .2s}
    .meal-card:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,.15)}
    .meal-card.completed{border-left-color:#28a745;background:linear-gradient(135deg,#f8fff9 0%,#e8f5e8 100%)}
    .meal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .meal-time{font-size:1.2rem;font-weight:700;color:#2c3e50}
    .meal-name{font-size:1rem;color:#7f8c8d}
    .complete-btn{padding:8px 16px;background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);color:#fff;border:none;border-radius:25px;cursor:pointer;font-weight:700}
    .complete-btn.completed{background:linear-gradient(135deg,#28a745 0%,#20c997 100%)}
    .food-options{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;margin-bottom:8px}
    .food-group{background:#f8f9fa;padding:12px;border-radius:10px}
    .food-group h4{color:#495057;margin:0 0 8px;font-size:.95rem;text-transform:uppercase;letter-spacing:.8px}
    .food-options-list{display:flex;flex-wrap:wrap;gap:8px}
    .food-option{padding:6px 10px;background:#fff;border:2px solid #e9ecef;border-radius:20px;font-size:.9rem;cursor:pointer}
    .food-option[aria-pressed="true"]{background:#4facfe;color:#fff;border-color:#4facfe}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;background:#fff;border:2px solid #e9ecef;border-radius:999px}
    .qty{min-width:2ch;text-align:center;font-weight:700}
    .pill-btn{border:none;background:#eef6ff;padding:2px 8px;border-radius:999px;cursor:pointer}
    .kcal{font-size:.8rem;color:#6c757d}
    .meal-calories{font-size:.95rem;color:#2c3e50;margin-top:6px;font-weight:700}
    .supplements{background:linear-gradient(135deg,#ffeaa7 0%,#fab1a0 100%);padding:12px;border-radius:10px;margin-top:8px}
    .supplements h4{margin:0 0 6px}
    .progress-section,.notes-section,.water-section{background:#fff;border-radius:15px;padding:20px;margin-bottom:16px;box-shadow:0 5px 15px rgba(0,0,0,.08)}
    .progress-bar{width:100%;height:18px;background:#e9ecef;border-radius:9px;overflow:hidden;margin:10px 0}
    .progress-fill{height:100%;background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);transition:width .4s;border-radius:9px}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-top:12px}
    .stat-card{background:linear-gradient(135deg,#a8edea 0%,#fed6e3 100%);padding:16px;border-radius:12px;text-align:center}
    .stat-number{font-size:1.4rem;font-weight:800;color:#2c3e50}
    .stat-label{color:#7f8c8d;font-size:.9rem;margin-top:4px}
    .goals{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;margin-top:10px}
    .goal-item{display:flex;align-items:center;gap:8px}
    .goal-item input{width:100%;padding:8px 10px;border:2px solid #e9ecef;border-radius:10px;font:inherit}
    .water-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    @media (max-width:768px){.header h1{font-size:1.6rem}.tab-panel{padding:18px}.meal-card{padding:18px}.food-options{grid-template-columns:1fr}}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>üçΩÔ∏è Controle de Dieta</h1>
      <div class="header-summary">
        <div id="headerMealCounter" class="summary-item">0 / 6 refei√ß√µes</div>
        <div id="headerCalorieCounter" class="summary-item">0 / 2600 kcal</div>
        <div id="headerWaterCounter" class="summary-item">0.0 / 2.2 L</div>
      </div>
      <div class="date-row">
        <span class="date-display" id="friendlyDate">‚Äî</span>
        <div class="controls-line">
          <button id="prevDayBtn" class="btn ghost" type="button">‚üµ Dia anterior</button>
          <input id="datePicker" class="input" type="date" />
          <button id="todayBtn" class="btn ghost" type="button">Hoje</button>
          <button id="nextDayBtn" class="btn ghost" type="button">Dia seguinte ‚ü∂</button>
        </div>
      </div>
      <div class="controls-line">
        <strong>Meta cal√≥rica r√°pida:</strong>
        <button id="btnCalRest" class="btn ghost" type="button">Descanso 2300</button>
        <button id="btnCalTrain" class="btn active" type="button">Treino 2600</button>
        <span style="opacity:.85">|</span>
        <strong>Meta d‚Äô√°gua r√°pida:</strong>
        <button id="btnWaterBase" class="btn ghost" type="button">2.2 L</button>
        <button id="btnWaterHigh" class="btn ghost" type="button">2.5 L</button>
      </div>
    </header>

    <div class="nav-tabs" role="tablist" aria-label="Se√ß√µes">
      <button id="tab-today" class="nav-tab" role="tab" aria-selected="true" aria-controls="panel-today">Hoje</button>
      <button id="tab-progress" class="nav-tab" role="tab" aria-selected="false" aria-controls="panel-progress">Progresso</button>
      <button id="tab-notes" class="nav-tab" role="tab" aria-selected="false" aria-controls="panel-notes">Anota√ß√µes</button>
    </div>

    <main>
      <!-- HOJE -->
      <section id="panel-today" class="tab-panel" role="tabpanel" aria-labelledby="tab-today" aria-hidden="false">
        <div id="mealsContainer"></div>

        <!-- √Ågua -->
        <div class="water-section">
          <h3>üíß Hidrata√ß√£o do dia</h3>
          <div class="water-row">
            <div><strong>Consumido:</strong> <span id="waterConsumedL">0</span> L</div>
            <div><strong>Meta:</strong> <span id="waterGoalL">2.2</span> L</div>
          </div>
          <div class="progress-bar"><div id="waterFill" class="progress-fill" style="width:0%"></div></div>
          <div class="water-row">
            <button class="btn" id="add250">+ 250 ml</button>
            <button class="btn" id="add500">+ 500 ml</button>
            <button class="btn" id="add1000">+ 1.000 ml</button>
            <span style="opacity:.85">|</span>
            <label>Meta manual (ml): <input id="waterGoalInput" class="input" type="number" min="0" step="50" style="width:120px"></label>
            <button class="btn" id="saveWaterGoal">Salvar meta de √°gua</button>
          </div>
        </div>
      </section>

      <!-- PROGRESSO -->
      <section id="panel-progress" class="tab-panel" role="tabpanel" aria-labelledby="tab-progress" aria-hidden="true">
        <div class="progress-section">
          <h3>Progresso do Dia</h3>
          <div class="progress-bar"><div id="progressFill" class="progress-fill" style="width:0%"></div></div>
          <p id="progressText">0% das refei√ß√µes conclu√≠das</p>

          <div class="goals">
            <div class="goal-item">
              <label for="goalFruit">Meta de frutas (por√ß√µes):</label>
              <input id="goalFruit" type="number" min="0" step="1"/>
            </div>
            <div class="goal-item">
              <label for="goalVeg">Meta de vegetais (por√ß√µes):</label>
              <input id="goalVeg" type="number" min="0" step="1"/>
            </div>
            <div class="goal-item">
              <label for="goalCalories">Meta de calorias (kcal):</label>
              <input id="goalCalories" type="number" min="0" step="50"/>
            </div>
            <button id="saveGoalsBtn" class="btn" type="button">Salvar metas</button>
          </div>
        </div>

        <div class="progress-section">
          <h3>üìà Evolu√ß√£o (√∫ltimos 14 dias)</h3>
          <canvas id="evolutionChart" height="120"></canvas>
        </div>

        <div class="progress-section">
          <h3>ü•ó Frutas & Vegetais (√∫ltimos 14 dias)</h3>
          <canvas id="fvChart" height="120"></canvas>
        </div>

        <div class="stats-grid">
          <div class="stat-card"><div class="stat-number" id="completedMeals">0</div><div class="stat-label">Refei√ß√µes conclu√≠das</div></div>
          <div class="stat-card"><div class="stat-number" id="totalMeals">6</div><div class="stat-label">Total de refei√ß√µes</div></div>
          <div class="stat-card"><div class="stat-number" id="currentStreak">0</div><div class="stat-label">Sequ√™ncia 100% (dias)</div></div>
          <div class="stat-card"><div class="stat-number" id="weeklyAverage">0%</div><div class="stat-label">M√©dia semanal</div></div>
          <div class="stat-card"><div class="stat-number" id="fruitProgress">0 / 0</div><div class="stat-label">Frutas (por√ß√µes/meta)</div></div>
          <div class="stat-card"><div class="stat-number" id="vegProgress">0 / 0</div><div class="stat-label">Vegetais (por√ß√µes/meta)</div></div>
          <div class="stat-card"><div class="stat-number" id="calProgress">0 / 0</div><div class="stat-label">Calorias (kcal consumidas/meta)</div></div>
        </div>
      </section>

      <!-- ANOTA√á√ïES -->
      <section id="panel-notes" class="tab-panel" role="tabpanel" aria-labelledby="tab-notes" aria-hidden="true">
        <div class="notes-section">
          <h3>Anota√ß√µes</h3>
          <textarea id="notesInput" class="notes-input" placeholder="Observa√ß√µes sobre o dia, fome, treino, sono..."></textarea>
          <button id="saveNotesBtn" class="btn" type="button">üíæ Salvar Anota√ß√µes</button>
        </div>
      </section>
    </main>
  </div>

  <script>
    // -------- Plano di√°rio (com vegetais por por√ß√£o) --------
    const dietPlan = [
      { time:"06:30", name:"Caf√© da manh√£", foods:{
          Prote√≠na:["3 ovos","120g frango","120g carne","120g peixe"],
          Carboidrato:["80g mandioca","100g batata-doce","100g arroz","80g cuscuz","80g macarr√£o integral"],
          Fruta:["banana (1 un)","ma√ß√£ (1 un)","laranja (1 un)","mixirica (1 un)","mam√£o (100g)","manga (100g)","uva (100g)","mel√£o (100g)","melancia (100g)"],
          Vegetais:["alface (1 por√ß√£o)","couve (50g)","r√∫cula (50g)","espinafre (50g)","cenoura (50g)","beterraba (50g)","br√≥colis (50g)"]
        },
        supplements:"30 min antes: Sel√™nio 200mcg | Ap√≥s: Vitamina D3 10.000ui + K2 200mcg, B12 1mg, √îmega 3 (6-8 c√°ps), Creatina 5g, NAC 600mg"
      },
      { time:"10:00", name:"Lanche / Pr√©-treino", foods:{
          Prote√≠na:["120g frango","120g carne","120g peixe","3 ovos"],
          Carboidrato:["80g batata-doce","100g arroz","80g mandioca","80g cuscuz","80g macarr√£o integral"],
          Fruta:["banana (1 un)","ma√ß√£ (1 un)","laranja (1 un)","mixirica (1 un)","mam√£o (100g)","manga (100g)","uva (100g)","mel√£o (100g)","melancia (100g)"],
          Vegetais:["alface (1 por√ß√£o)","couve (50g)","r√∫cula (50g)","espinafre (50g)","cenoura (50g)","beterraba (50g)","br√≥colis (50g)"]
        },
        supplements:"Pr√©-treino (se treino 12h): Glicerina 15ml em 1L √°gua"
      },
      { time:"13:00", name:"Almo√ßo (p√≥s-treino)", foods:{
          Prote√≠na:["150g frango","150g carne","150g peixe","3 ovos"],
          Carboidrato:["120g arroz","120g batata-doce","120g mandioca","120g batata inglesa","120g feij√£o cozido","120g lentilha cozida","120g gr√£o-de-bico cozido","100g cuscuz","100g macarr√£o integral"],
          Fruta:["banana (1 un)","ma√ß√£ (1 un)","laranja (1 un)","mixirica (1 un)","mam√£o (100g)","manga (100g)","uva (100g)","mel√£o (100g)","melancia (100g)"],
          Vegetais:["salada verde (1 por√ß√£o)","couve (50g)","r√∫cula (50g)","espinafre (50g)","cenoura (50g)","beterraba (50g)","br√≥colis (50g)"]
        },
        supplements:"Ap√≥s refei√ß√£o: Col√°geno tipo II 40mg, Glucosamina 1,5g + Condroitina 1,2g"
      },
      { time:"16:00", name:"Lanche da tarde", foods:{
          Prote√≠na:["120g frango","120g carne","120g peixe","3 ovos"],
          Carboidrato:["100g arroz","80g batata-doce","80g mandioca","80g cuscuz","80g macarr√£o integral"],
          Fruta:["banana (1 un)","ma√ß√£ (1 un)","laranja (1 un)","mixirica (1 un)","mam√£o (100g)","manga (100g)","uva (100g)","mel√£o (100g)","melancia (100g)"],
          Vegetais:["alface (1 por√ß√£o)","couve (50g)","r√∫cula (50g)","espinafre (50g)","cenoura (50g)","beterraba (50g)","br√≥colis (50g)"]
        },
        supplements:"Sem manipulados fixos"
      },
      { time:"19:00", name:"Jantar", foods:{
          Prote√≠na:["150g frango","150g carne","150g peixe","3 ovos"],
          "Carboidrato (opcional)":["80g arroz","80g batata-doce","80g mandioca","80g batata inglesa","80g cuscuz","80g macarr√£o integral","100g feij√£o cozido","100g lentilha cozida","100g gr√£o-de-bico cozido"],
          Fruta:["banana (1 un)","ma√ß√£ (1 un)","laranja (1 un)","mixirica (1 un)","mam√£o (100g)","manga (100g)","uva (100g)","mel√£o (100g)","melancia (100g)"],
          Vegetais:["salada verde (1 por√ß√£o)","couve (50g)","r√∫cula (50g)","espinafre (50g)","cenoura (50g)","beterraba (50g)","br√≥colis (50g)"]
        },
        supplements:"Sem manipulados fixos"
      },
      { time:"21:00", name:"Antes de dormir", foods:{},
        supplements:"1h antes: Magn√©sio 500mg + Zinco 30mg + Vitamina C 1g | Antes dormir: Melatonina SL 2mg, Glicina 3g"
      }
    ];

    // -------- Calorias (cozidos; valores m√©dios realistas) --------
    const kcalDB = {
      // Prote√≠nas
      "3 ovos":210, "120g frango":198, "150g frango":248,
      "120g carne":230, "150g carne":290,
      "120g peixe":170, "150g peixe":213,

      // Carboidratos (cozidos)
      "80g mandioca":128, "120g mandioca":192,
      "80g batata-doce":69, "100g batata-doce":86, "120g batata-doce":103,
      "80g batata inglesa":62, "120g batata inglesa":93,
      "100g arroz":130, "120g arroz":156,
      "80g cuscuz":96, "100g cuscuz":120,
      "80g macarr√£o integral":110, "100g macarr√£o integral":138,
      "100g feij√£o cozido":76,  "120g feij√£o cozido":91,
      "100g lentilha cozida":116, "120g lentilha cozida":139,
      "100g gr√£o-de-bico cozido":164, "120g gr√£o-de-bico cozido":197,

      // Vegetais / Folhas (por por√ß√£o indicada)
      "alface (1 por√ß√£o)":5,
      "salada verde (1 por√ß√£o)":10,
      "couve (50g)":18,
      "r√∫cula (50g)":12,
      "espinafre (50g)":12,
      "cenoura (50g)":20,
      "beterraba (50g)":22,
      "br√≥colis (50g)":17,

      // Frutas
      "banana (1 un)":105, "ma√ß√£ (1 un)":95, "laranja (1 un)":62, "mixirica (1 un)":47,
      "mam√£o (100g)":43, "manga (100g)":60, "uva (100g)":69, "mel√£o (100g)":34, "melancia (100g)":30
    };

    // -------- Datas, metas, storage --------
    const STORAGE_PREFIX = 'dietData-';
    const GOALS_KEY = 'dietGoals';
    const WATER_GOAL_KEY = 'waterGoalMl';

    let selectedDate = today();
    let mealStatus = {};
    let selectedFoods = {};
    let dailyNotes = '';
    let goals = loadGoals(); // {fruitServings, vegServings, dailyCalories}
    let evolutionChart, fvChart;

    function today(){ const d=new Date(); d.setHours(0,0,0,0); return d; }
    const toISO = (d)=>new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())).toISOString().slice(0,10);
    const fromISO = (iso)=>{ const [y,m,dd]=iso.split('-').map(Number); const dt=new Date(); dt.setFullYear(y, m-1, dd); dt.setHours(0,0,0,0); return dt; };
    const dayKey = (d)=> STORAGE_PREFIX + toISO(d);

    function formatFriendly(d){
      return d.toLocaleDateString('pt-BR', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
    }

    function loadGoals(){
      const g = JSON.parse(localStorage.getItem(GOALS_KEY) || '{}');
      return {
        fruitServings: g.fruitServings ?? 3,
        vegServings: g.vegServings ?? 3,
        dailyCalories: g.dailyCalories ?? 2600
      };
    }
    function saveGoals(go){ localStorage.setItem(GOALS_KEY, JSON.stringify(go)); }

    function getWaterGoalMl(){
      const saved = Number(localStorage.getItem(WATER_GOAL_KEY));
      return Number.isFinite(saved) && saved>0 ? saved : 2200;
    }
    function setWaterGoalMl(v){ localStorage.setItem(WATER_GOAL_KEY, String(Math.max(0, Math.floor(v)))); renderWater(); renderHeader(); }

    function saveDayPercent(d, percent){
      const histKey = 'dietHistory';
      const hist = JSON.parse(localStorage.getItem(histKey) || '{}');
      hist[toISO(d)] = percent;
      localStorage.setItem(histKey, JSON.stringify(hist));
    }
    function getHistory(n=14){
      const hist = JSON.parse(localStorage.getItem('dietHistory')||'{}');
      const labels=[], data=[];
      for(let i=n-1;i>=0;i--){
        const d=new Date(); d.setDate(d.getDate()-i);
        const k=toISO(d);
        labels.push(d.toLocaleDateString('pt-BR', { day:'2-digit', month:'2-digit' }));
        data.push(hist[k] ?? 0);
      }
      return { labels, data };
    }
    function calcWeeklyAverage(){
      const hist = JSON.parse(localStorage.getItem('dietHistory')||'{}');
      const arr=[]; for(let i=6;i>=0;i--){ const d=new Date(); d.setDate(d.getDate()-i); const v=hist[toISO(d)]; if(v!=null) arr.push(v); }
      if(!arr.length) return 0;
      const s=arr.reduce((a,b)=>a+b,0); return Math.round(s/arr.length);
    }
    function calcStreak(th=100){
      const hist = JSON.parse(localStorage.getItem('dietHistory')||'{}');
      let s=0;
      for(let i=0;;i++){
        const d=new Date(); d.setDate(d.getDate()-i);
        const v=hist[toISO(d)];
        if(v==null || v<th) break;
        s++;
      }
      return s;
    }

    function getKcal(label){ return kcalDB[label] ?? 0; }

    function mealCalories(index){
      const sel = selectedFoods[index] || {};
      let t=0;
      for(const [cat,val] of Object.entries(sel)){
        if((cat==='Fruta' || cat==='Vegetais') && val && typeof val==='object'){
          for(const [opt, qty] of Object.entries(val)){ if(!qty) continue; t += getKcal(opt)*qty; }
        } else if(typeof val==='string'){ t += getKcal(val); }
      }
      return t;
    }
    function dayCalories(){ let s=0; for(let i=0;i<dietPlan.length;i++) s+=mealCalories(i); return s; }

    function fruitServingsConsumed(obj = selectedFoods){
      let s=0; for(const idx in obj){ const f=obj[idx]?.Fruta; if(!f) continue; for(const q of Object.values(f)) s += (q||0); }
      return s;
    }
    function vegServingsConsumed(obj = selectedFoods){
      let s=0; for(const idx in obj){ const v=obj[idx]?.Vegetais; if(!v) continue; for(const q of Object.values(v)) s += (q||0); }
      return s;
    }

    function saveAll(){
      const raw = JSON.parse(localStorage.getItem(dayKey(selectedDate)) || '{}');
      const waterMl = Number(raw.waterMl || 0);
      localStorage.setItem(dayKey(selectedDate), JSON.stringify({ mealStatus, selectedFoods, dailyNotes, waterMl, date: toISO(selectedDate) }));
    }
    function loadAll(){
      const raw = localStorage.getItem(dayKey(selectedDate));
      if(raw){
        const data = JSON.parse(raw);
        mealStatus = data.mealStatus || {};
        selectedFoods = data.selectedFoods || {};
        // migra√ß√£o antiga: se era string, converte
        for(const [idx,obj] of Object.entries(selectedFoods)){
          if(obj?.Fruta && typeof obj.Fruta === 'string'){ obj.Fruta = { [obj.Fruta]: 1 }; }
          if(obj?.Vegetais && typeof obj.Vegetais === 'string'){ obj.Vegetais = { [obj.Vegetais]: 1 }; }
        }
        dailyNotes = data.dailyNotes || '';
      } else {
        mealStatus = {}; selectedFoods = {}; dailyNotes = '';
      }
    }
    function getWaterMl(){ const raw = JSON.parse(localStorage.getItem(dayKey(selectedDate)) || '{}'); return Number(raw.waterMl || 0); }
    function setWaterMl(v){
      const rec = JSON.parse(localStorage.getItem(dayKey(selectedDate)) || '{}');
      rec.waterMl = Math.max(0, Math.floor(v));
      localStorage.setItem(dayKey(selectedDate), JSON.stringify(rec));
      renderWater();
    }

    // -------- Render geral --------
    function renderHeader(){
      document.getElementById('friendlyDate').textContent = formatFriendly(selectedDate);
      document.getElementById('datePicker').value = toISO(selectedDate);
      document.getElementById('btnCalTrain').classList.toggle('active', goals.dailyCalories==2600);
      document.getElementById('btnCalRest').classList.toggle('active', goals.dailyCalories==2300);
      document.getElementById('btnWaterBase').classList.toggle('active', getWaterGoalMl()==2200);
      document.getElementById('btnWaterHigh').classList.toggle('active', getWaterGoalMl()==2500);
    }

    function renderMeals(){
      const wrap = document.getElementById('mealsContainer'); wrap.textContent='';
      dietPlan.forEach((meal,index)=>{
        const card=document.createElement('article'); card.className='meal-card'+(mealStatus[index]?' completed':'');
        const h=document.createElement('div'); h.className='meal-header';
        const l=document.createElement('div');
        const t=document.createElement('div'); t.className='meal-time'; t.textContent=meal.time;
        const n=document.createElement('div'); n.className='meal-name'; n.textContent=meal.name;
        l.append(t,n);
        const btn=document.createElement('button'); btn.className='complete-btn'+(mealStatus[index]?' completed':''); btn.type='button';
        btn.dataset.action='toggle-meal'; btn.dataset.index=String(index);
        btn.textContent=mealStatus[index]?'‚úì Conclu√≠da':'Marcar como Conclu√≠da';
        h.append(l,btn); card.appendChild(h);

        const categories=Object.entries(meal.foods||{});
        if(categories.length){
          const optWrap=document.createElement('div'); optWrap.className='food-options';
          categories.forEach(([cat,options])=>{
            if(!options?.length) return;
            const g=document.createElement('div'); g.className='food-group';
            const title=document.createElement('h4'); title.textContent=cat;
            const list=document.createElement('div'); list.className='food-options-list';

            if(cat==='Fruta' || cat==='Vegetais'){
              const store = selectedFoods[index]?.[cat] || {};
              options.forEach(option=>{
                const item=document.createElement('div'); item.className='pill';
                const dec=document.createElement('button'); dec.className='pill-btn'; dec.type='button'; dec.textContent='‚àí';
                dec.dataset.action=(cat==='Fruta'?'fruit-dec':'veg-dec'); dec.dataset.mealIndex=String(index); dec.dataset.option=option;
                const qty=document.createElement('span'); qty.className='qty'; qty.textContent=String(store[option]||0);
                qty.dataset.mealIndex=String(index); qty.dataset.option=option; qty.dataset.kind=cat;
                const inc=document.createElement('button'); inc.className='pill-btn'; inc.type='button'; inc.textContent='+';
                inc.dataset.action=(cat==='Fruta'?'fruit-inc':'veg-inc'); inc.dataset.mealIndex=String(index); inc.dataset.option=option;
                const lbl=document.createElement('span'); lbl.textContent=option;
                const kc=document.createElement('span'); kc.className='kcal'; kc.textContent=`(${kcalDB[option]||0} kcal/por√ß√£o)`;
                item.append(dec,qty,inc,lbl,kc); list.appendChild(item);
              });
            } else {
              // sele√ß√£o √∫nica (prote√≠na, carboidrato)
              options.forEach(option=>{
                const b=document.createElement('button'); b.className='food-option'; b.type='button';
                b.setAttribute('aria-pressed', String(selectedFoods[index]?.[cat]===option));
                b.dataset.action='select-food'; b.dataset.mealIndex=String(index); b.dataset.category=cat; b.dataset.option=option;
                b.textContent=`${option} ¬∑ ${(kcalDB[option]??0)} kcal`;
                list.appendChild(b);
              });
            }
            g.append(title,list); optWrap.appendChild(g);
          });
          card.appendChild(optWrap);
        }

        const kcal=document.createElement('div'); kcal.className='meal-calories'; kcal.id=`meal-kcal-${index}`;
        kcal.textContent=`Calorias estimadas desta refei√ß√£o: ${mealCalories(index)} kcal`;
        card.appendChild(kcal);

        if(meal.supplements){
          const sup=document.createElement('div'); sup.className='supplements';
          const h4=document.createElement('h4'); h4.textContent='üíä Suplementa√ß√£o';
          const p=document.createElement('div'); p.className='supplement-list'; p.textContent=meal.supplements;
          sup.append(h4,p); card.appendChild(sup);
        }

        wrap.appendChild(card);
      });
    }

    function updateHeaderSummary(){
      const completed=Object.values(mealStatus).filter(Boolean).length;
      const total=dietPlan.length;
      const dcal=dayCalories();
      document.getElementById('headerMealCounter').textContent = `${completed} / ${total} refei√ß√µes`;
      document.getElementById('headerCalorieCounter').textContent = `${dcal} / ${goals.dailyCalories} kcal`;
      const ml = getWaterMl(), goal = getWaterGoalMl();
      document.getElementById('headerWaterCounter').textContent = `${(ml/1000).toFixed(1)} / ${(goal/1000).toFixed(1)} L`;
    }

    function updateProgress(saveHist=true){
      const completed=Object.values(mealStatus).filter(Boolean).length;
      const total=dietPlan.length;
      const percent = total > 0 ? Math.round((completed/total)*100) : 0;
      const dcal=dayCalories();
      const f=fruitServingsConsumed();
      const v=vegServingsConsumed();

      document.getElementById('progressFill').style.width=percent+'%';
      document.getElementById('progressText').textContent=`${percent}% das refei√ß√µes conclu√≠das`;
      document.getElementById('completedMeals').textContent=String(completed);
      document.getElementById('totalMeals').textContent=String(total);

      if(saveHist) saveDayPercent(selectedDate, percent);
      document.getElementById('currentStreak').textContent=String(calcStreak(100));
      document.getElementById('weeklyAverage').textContent=`${calcWeeklyAverage()}%`;

      document.getElementById('fruitProgress').textContent=`${f} / ${goals.fruitServings}`;
      document.getElementById('vegProgress').textContent=`${v} / ${goals.vegServings}`;
      document.getElementById('calProgress').textContent=`${dcal} / ${goals.dailyCalories}`;

      updateHeaderSummary();
      renderEvolution();
      renderFVChart();
    }

    function renderWater(){
      const ml = getWaterMl();
      const goal = getWaterGoalMl();
      const pct = goal ? Math.min(100, Math.round((ml/goal)*100)) : 0;
      document.getElementById('waterConsumedL').textContent = (ml/1000).toFixed(2);
      document.getElementById('waterGoalL').textContent = (goal/1000).toFixed(1);
      document.getElementById('waterFill').style.width = pct + '%';
      document.getElementById('waterGoalInput').value = String(goal);
      updateHeaderSummary();
    }

    // ---------- Gr√°ficos ----------
    function renderEvolution(){
      if(!window.Chart) return;
      const ctx = document.getElementById('evolutionChart').getContext('2d');
      const { labels, data } = getHistory(14);
      if(evolutionChart){
        evolutionChart.data.labels = labels;
        evolutionChart.data.datasets[0].data = data;
        evolutionChart.update();
        return;
      }
      evolutionChart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets: [{ label:'% do dia conclu√≠da', data, tension:0.3 }]},
        options: { responsive:true, scales:{ y:{ beginAtZero:true, max:100, ticks:{ stepSize:20 }}}, plugins:{ legend:{ display:true } } }
      });
    }

    function getFVHistory(n=14){
      const labels=[], fruits=[], vegs=[];
      for(let i=n-1;i>=0;i--){
        const d=new Date(); d.setDate(d.getDate()-i);
        const key = STORAGE_PREFIX + toISO(d);
        labels.push(d.toLocaleDateString('pt-BR', { day:'2-digit', month:'2-digit' }));
        const raw = localStorage.getItem(key);
        if(!raw){ fruits.push(0); vegs.push(0); continue; }
        const rec = JSON.parse(raw);
        const sf = fruitServingsConsumed(rec.selectedFoods || {});
        const sv = vegServingsConsumed(rec.selectedFoods || {});
        fruits.push(sf); vegs.push(sv);
      }
      return { labels, fruits, vegs };
    }

    function renderFVChart(){
      if(!window.Chart) return;
      const ctx = document.getElementById('fvChart').getContext('2d');
      const { labels, fruits, vegs } = getFVHistory(14);
      if(fvChart){
        fvChart.data.labels = labels;
        fvChart.data.datasets[0].data = fruits;
        fvChart.data.datasets[1].data = vegs;
        fvChart.update();
        return;
      }
      fvChart = new Chart(ctx, {
        type: 'line',
        data: { 
          labels, 
          datasets: [
            { label:'Frutas (por√ß√µes)', data: fruits, tension:0.3 },
            { label:'Vegetais (por√ß√µes)', data: vegs, tension:0.3 }
          ]
        },
        options: { responsive:true, scales:{ y:{ beginAtZero:true, ticks:{ stepSize:1 }}}, plugins:{ legend:{ display:true } } }
      });
    }

    // -------- Tabs --------
    function setActiveTab(tabId){
      const panels=['panel-today','panel-progress','panel-notes'];
      const tabs=['tab-today','tab-progress','tab-notes'];
      tabs.forEach((id,i)=>{
        const active=id===tabId;
        document.getElementById(id).setAttribute('aria-selected', String(active));
        document.getElementById(panels[i]).setAttribute('aria-hidden', String(!active));
      });
      if(tabId==='tab-progress'){
        document.getElementById('goalFruit').value=String(goals.fruitServings);
        document.getElementById('goalVeg').value=String(goals.vegServings);
        document.getElementById('goalCalories').value=String(goals.dailyCalories);
        renderEvolution(); renderFVChart(); updateProgress(false);
      }
      if(tabId==='tab-notes'){ document.getElementById('notesInput').value=dailyNotes; }
    }

    // -------- Intera√ß√µes --------
    function setupInteractions(){
      const container=document.getElementById('mealsContainer');
      container.addEventListener('click',(e)=>{
        const t=e.target; if(!(t instanceof HTMLElement)) return;
        const target = t.closest('[data-action]');
        if(!target) return;
        const { action, mealIndex, index, category, option } = target.dataset;

        if(action==='toggle-meal'){
          const idx=Number(index);
          mealStatus[idx]=!mealStatus[idx];
          saveAll(); renderMeals(); updateProgress();
          return;
        }
        if(action==='select-food'){
          const idx=Number(mealIndex);
          selectedFoods[idx] ||= {};
          selectedFoods[idx][category] = selectedFoods[idx][category] === option ? undefined : option;
          saveAll(); renderMeals(); updateProgress(false);
          return;
        }
        if(action==='fruit-inc' || action==='fruit-dec' || action==='veg-inc' || action==='veg-dec'){
          const idx=Number(mealIndex);
          const kind = action.startsWith('fruit') ? 'Fruta' : 'Vegetais';
          selectedFoods[idx] ||= {}; selectedFoods[idx][kind] ||= {};
          const cur = selectedFoods[idx][kind][option] || 0;
          const next = Math.max(0, cur + (action.endsWith('inc') ? 1 : -1));
          selectedFoods[idx][kind][option] = next;
          saveAll(); renderMeals(); updateProgress(false);
          return;
        }
      });

      // notas
      document.getElementById('saveNotesBtn').addEventListener('click',(e)=>{
        dailyNotes=document.getElementById('notesInput').value;
        saveAll();
        const btn=e.currentTarget; btn.textContent='‚úì Salvo!'; btn.classList.add('active');
        setTimeout(()=>{ btn.textContent='üíæ Salvar Anota√ß√µes'; btn.classList.remove('active'); },1200);
      });

      // metas
      document.getElementById('saveGoalsBtn').addEventListener('click',()=>{
        const f=Number(document.getElementById('goalFruit').value || goals.fruitServings);
        const v=Number(document.getElementById('goalVeg').value || goals.vegServings);
        const c=Number(document.getElementById('goalCalories').value || goals.dailyCalories);
        goals={ fruitServings:Math.max(0,Math.floor(f)), vegServings:Math.max(0,Math.floor(v)), dailyCalories:Math.max(0,Math.floor(c)) };
        saveGoals(goals); renderHeader(); updateProgress(false);
        alert('Metas salvas!');
      });

      // kcal r√°pidas
      document.getElementById('btnCalRest').addEventListener('click',()=>{ goals.dailyCalories=2300; saveGoals(goals); renderHeader(); updateProgress(false); });
      document.getElementById('btnCalTrain').addEventListener('click',()=>{ goals.dailyCalories=2600; saveGoals(goals); renderHeader(); updateProgress(false); });

      // √°gua
      document.getElementById('add250').addEventListener('click',()=> setWaterMl(getWaterMl()+250));
      document.getElementById('add500').addEventListener('click',()=> setWaterMl(getWaterMl()+500));
      document.getElementById('add1000').addEventListener('click',()=> setWaterMl(getWaterMl()+1000));
      document.getElementById('saveWaterGoal').addEventListener('click',()=>{
        const v = Number(document.getElementById('waterGoalInput').value || getWaterGoalMl());
        setWaterGoalMl(v);
      });

      // datas
      const changeDay = (offset)=>{ selectedDate.setDate(selectedDate.getDate()+offset); fullRender(); };
      document.getElementById('prevDayBtn').addEventListener('click',()=> changeDay(-1));
      document.getElementById('nextDayBtn').addEventListener('click',()=> changeDay(1));
      document.getElementById('todayBtn').addEventListener('click',()=>{ selectedDate=today(); fullRender(); });
      document.getElementById('datePicker').addEventListener('change',(e)=>{ selectedDate=fromISO(e.target.value); fullRender(); });
    }

    function fullRender(){
      loadAll();
      renderHeader();
      renderMeals();
      renderWater();
      updateProgress(false);
    }

    // -------- Inicializa√ß√£o --------
    document.addEventListener('DOMContentLoaded',()=>{
      document.querySelector('.nav-tabs').addEventListener('click',(e)=>{
        const btn=e.target.closest('.nav-tab'); if(!btn) return;
        setActiveTab(btn.id);
      });
      setupInteractions();
      fullRender();
    });
  </script>
</body>
</html>
